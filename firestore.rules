
/*
The following command is required to create a composite index for the 'interviews' collection.
This allows querying interviews by userId and ordering them by creation date, which is
necessary for the dashboard and history pages to function correctly under the new security rules.

Run this command in your gcloud shell:

gcloud firestore indexes composite create \
  --collection-group=interviews \
  --query-scope=COLLECTION \
  --field-path=userId,ASCENDING \
  --field-path=createdAt,DESCENDING

*/
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read and write their own profile document.
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Users can only manage their own interviews.
    match /interviews/{interviewId} {
      // Allow read and delete for a single document if the user is the owner.
      allow get, delete: if request.auth != null && get(/databases/$(database)/documents/interviews/$(interviewId)).data.userId == request.auth.uid;
      
      // Allow listing documents if the query is filtered by the user's own ID.
      allow list: if request.auth != null && request.query.filters.size() == 1 && 'userId' in request.query.filters[0] && request.query.filters[0].userId == request.auth.uid;

      // Allow create if the incoming document's userId matches the user's auth uid.
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;

      // Allow update if the user is the owner and they are not changing the owner.
      allow update: if request.auth != null && resource.data.userId == request.auth.uid && request.resource.data.userId == resource.data.userId;
    }
  }
}
